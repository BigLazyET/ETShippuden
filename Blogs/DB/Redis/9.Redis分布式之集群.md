Redis分布式之集群
-------------

### 官方链接
* [Redis中文官方文档](http://www.redis.cn/)
* [Redis哨兵系统](http://www.redis.cn/topics/sentinel.html)
* [Redis集群模式](http://www.redis.cn/topics/cluster-tutorial.html)
* [Redis集群规范](http://www.redis.cn/topics/cluster-spec.html)

### 包含

* Redis主从
* Redis多主多从
* Redis分片集群
* Redis分片集群+主从

**Redis版本：3.0及其以上**

### 一、Redis集群基本介绍

Redis集群是一个提供在多个Redis间节点间共享数据的程序集

Redis**官方**集群不支持处理多个keys的命令，因为这需要在不同节点之间移动数据，从而达不到像Redis那样的性能

Redis集群通过分区提供一定程度的可用性，在实际环境中，当某个节点宕机或者不可达，Redis集群可以：
* 自动分割数据到不同的节点上
* 整个集群的部分节点失败或者不可达的情况能继续处理命令

### 二、Redis集群的数据分片

#### 1. 基本认识
**Redis集群没有使用一致性hash，而是使用 哈希槽的概念**

* Redis集群有**16384**个哈希槽
* 每个key经过CRC16校验后对16384取模决定被放置在哪个槽
* Redis集群的每个节点都负责一部分hash槽

#### 2. 举例说明

比如当前集群有三个节点：A，B，C
* A节点分配哈希槽段：0到5500
* B节点分配哈希槽段：5501到11000
* C节点分配哈希槽段：11001到163384

##### 添加节点D
将A,B,C节点上的部分槽根据规则转移到D节点上

#### 删除节点A
* 将A上的哈希槽分配到B和C上
* 删除没有任何哈希槽的A节点

**由于从一个节点将哈希槽转移到另一个节点不会停止服务，所以无论添加或者删除节点，不会导致整个集群不可用**

### 三、Redis集群的主从复制模型

为了防止部分节点失败或者网络不可用的情况下整个集群仍然可用，所以针对每个节点都可以部署N-1个复制节点（==为什么是N-1==）

已知A,B,C三个节点，当B不可用时，如果不适用主从复制模式，会造成5001-11000段的哈希槽不可用

集群创建时或者创建后，为节点A,B,C添加一个从节点A1,B1,C1，这样会形成三主三从的集群；当B节点不可用，B1会推选为新的 主节点继续服务

当B,B1都不可用，则集群就无法使用5001-11000段的哈希槽

### 四、Redis一致性保证

Redis集群不能保证数据的**强一致性**，可能会丢失写操作

#### 1. Redis集群的异步复制

* Redis主节点接收到客户端发过来的写命令
* Redis主节点向客户端回复写命令后的状态信息
* Redis主节点将写命令复制给它的所有从节点

步骤三会由于各种问题可能会导致写命令未复制给从节点，导致数据的不一致性

如果采用主节点自己执行完写命令+将写命令复制给所有从节点之后，再回复给客户端写命令的状态消息，这能最大程度保证数据的一致性，但是这会大程度影响性能，并发量下降。
**所以必须在数据一致性跟性能并发之间做出选择**

==此思想在PG中也有相应的配置==

#### 2. 网络分裂(脑裂问题)

集群节点：主：A,B,C 从：A1,B1,C1；客户端：Z1

在集群发生网络分裂的情况下，当客户端Z1与其中被孤立的一部分B进行写操作时，如果另一部分重新推选出了主节点B1 ，那么客户端与之前被孤立的一部分进行的写操作数据将会被遗失

Redis分布式之集群规范
-------------

### 一、实现的功能子集

* 分布式集群**实现**了所有在**非分布式Redis版本中出现的处理单一键值key的命令**
* 针对多个键值的复杂操作，都没有实现
* 可以通过使用MIGRATE COPY命令，在集群上用计算节点来执行多键值的**只读操作**，Redis集群本身不会执行复杂的多键值操作来把键值在节点间移动
* Redis单机版支持多个数据库；集群不支持(只有数据库0)，且不支持SELECT命令

### 二、Redis多个数据库

* Redis单机版支持多个数据库
* Redis集群没有数据库的概念
* 每个数据库的数据是隔离的，不能共享

#### 1. Redis数据库

* Redis实例提供了多个用来存储数据的字典，客户端可以指定将数据存储在哪个字典中(与一个关系数据库实例中可以创建多个数据库类似)，所以可以将其中一个字典理解成一个独立的数据库
* 每个数据库对外都是一个编号，编号从0开始递增
* ==Redis默认支持16个数据库(可以通过配置文件配置database支持更多，无上限)==
* **默认来说，客户端与Redis建立连接后回自动选择0号数据库**
* 可以使用SELECT命令更换数据库
* 每个数据库都有属于自己的空间，**不必担心之间的key冲突**
* 不同的数据库，相同的key取到各自的值
* **flushdb**命令清除数据：只会清除当前数据库下的数据，不会影响到其他数据库
* **flushall**命令会清除这个redis实例的数据，所以格外小心！！
```
// 选择1号数据库
SELECT 1
GET foo
```

#### 2. Redis数据库与传统数据库的区别

* Redis数据库不支持自定义名称，只能用编号命名
* Redis数据库不支持为每个数据库设置不同的访问密码，也就是说所有数据库的访问权限是一致的
* Redis多个数据库不是完全隔离的，使用FLUSHALL命令会清空所有数据库
* 因为上述原因，Redis数据库不支持存储不同应用程序的数据；适用于存储一个应用程序的不同环境的数据
* 针对不同的应用程序，使用不同的Redis实例去存储，一个Redis实例占据的内存1M左右，所以不用担心多个Redis实例占用内存的问题

http://www.redis.cn/topics/cluster-spec.html